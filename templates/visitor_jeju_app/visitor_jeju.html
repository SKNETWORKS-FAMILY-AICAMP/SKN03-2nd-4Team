
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    {% load static %}
    <title>제주 방문자 데이터 시각화</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h1>제주 방문자 데이터 시각화</h1>
        
        <form method="post">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit">조회</button>
        </form>

        {% if chart_data %}
            <!-- 선형 그래프 -->
            <h2>월별 방문자 수 (개인 여행)</h2>
            <canvas id="myChart" width="400" height="200"></canvas>
            <script>
                const ctx = document.getElementById('myChart').getContext('2d');
                const data = JSON.parse('{{ chart_data|safe }}');
                const fullTableData = JSON.parse('{{ full_table_data|safe }}');
                
                console.log(data);
                console.log(fullTableData);

                const labels = Object.keys(data);
                const values = Object.values(data);

                const myChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '월별 방문자 수 (개인 여행)',
                            data: values,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1,
                            fill: false
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const chartElement = elements[0];
                                const clickedLabel = myChart.data.labels[chartElement.index];

                                // 클릭된 레이블에 해당하는 데이터 필터링
                                const filteredData = fullTableData.filter(row => row['YearMonth'] === clickedLabel);
                                
                                // 표 업데이트
                                const tableBody = document.getElementById('data-table-body');
                                tableBody.innerHTML = ''; // 기존 표 내용 제거

                                filteredData.forEach(row => {
                                    const tr = document.createElement('tr');
                                    tr.innerHTML = `
                                        <td>${row['YearMonth']}</td>
                                        <td>${row['personal_trip']}</td>
                                        <td>${row['package']}</td>
                                        <td>${row['leisure']}</td>
                                        <td>${row['work']}</td>
                                        <td>${row['recreation']}</td>
                                        <td>${row['JPN']}</td>
                                        <td>${row['CHN']}</td>
                                        <td>${row['USA']}</td>
                                    `;
                                    tableBody.appendChild(tr);
                                });
                            }
                        }
                    }
                });
            </script>
        {% endif %}

        {% if full_table_data %}
            <!-- 데이터 표 -->
            <h2>필터링된 데이터</h2>
            <table border="1" id="data-table">
                <thead>
                    <tr>
                        <th>연-월</th>
                        <th>개인 여행</th>
                        <th>패키지 여행</th>
                        <th>레저 여행</th>
                        <th>업무 여행</th>
                        <th>여가 여행</th>
                        <th>일본 방문자 수</th>
                        <th>중국 방문자 수</th>
                        <th>미국 방문자 수</th>
                    </tr>
                </thead>
                <tbody id="data-table-body">
                    {% for row in full_table_data %}
                        <tr>
                            <td>{{ row.YearMonth }}</td>
                            <td>{{ row.personal_trip }}</td>
                            <td>{{ row.package }}</td>
                            <td>{{ row.leisure }}</td>
                            <td>{{ row.work }}</td>
                            <td>{{ row.recreation }}</td>
                            <td>{{ row.JPN }}</td>
                            <td>{{ row.CHN }}</td>
                            <td>{{ row.USA }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- 막대 그래프 -->
            <h2>막대 그래프</h2>
            <canvas id="barChart" width="400" height="200"></canvas>
            <script>
                const barCtx = document.getElementById('barChart').getContext('2d');
                
                // 막대 그래프를 위한 데이터 준비
                const personalTripData = fullTableData.map(row => row['personal_trip']);
                const packageTripData = fullTableData.map(row => row['package']);
                const leisureData = fullTableData.map(row => row['leisure']);
                const workData = fullTableData.map(row => row['work']);
                const recreationData = fullTableData.map(row => row['recreation']);

                const barChart = new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,  // 기존에 정의한 labels 사용
                        datasets: [
                            {
                                label: '개인 여행',
                                data: personalTripData,
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            },
                            {
                                label: '패키지 여행',
                                data: packageTripData,
                                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                                borderColor: 'rgba(153, 102, 255, 1)',
                                borderWidth: 1
                            },
                            {
                                label: '레저 여행',
                                data: leisureData,
                                backgroundColor: 'rgba(255, 159, 64, 0.2)',
                                borderColor: 'rgba(255, 159, 64, 1)',
                                borderWidth: 1
                            },
                            {
                                label: '업무 여행',
                                data: workData,
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            },
                            {
                                label: '여가 여행',
                                data: recreationData,
                                backgroundColor: 'rgba(255, 206, 86, 0.2)',
                                borderColor: 'rgba(255, 206, 86, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            </script>
        {% endif %}
    </div>
</body>
</html>