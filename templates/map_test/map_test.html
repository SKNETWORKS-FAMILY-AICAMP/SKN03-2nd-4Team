<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    {% load static %}
    <title>제주 방문자 데이터 시각화</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h1>제주 방문자 데이터 시각화</h1>
        
        <form method="post">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit">조회</button>
        </form>

        {% if chart_data %}
            <h2>월별 방문자 수</h2>
            <canvas id="lineChart" width="400" height="200"></canvas>
            <script>
                const ctx = document.getElementById('lineChart').getContext('2d');
                const chartData = JSON.parse('{{ chart_data|safe }}');
                const labels = Object.keys(chartData);
                const values = Object.values(chartData);

                const lineChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '월별 방문자 수',
                            data: values,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 2,
                            fill: false
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const chartElement = elements[0];
                                const clickedLabel = lineChart.data.labels[chartElement.index];
                                updateTable(clickedLabel);
                            }
                        }
                    }
                });

                function updateTable(clickedLabel) {
                    {% if full_table_data %}
                        const fullTableData = JSON.parse('{{ full_table_data|safe }}');
                        const filteredData = fullTableData.filter(row => row['date'] === clickedLabel);
                        const tableBody = document.getElementById('data-table-body');
                        tableBody.innerHTML = '';

                        filteredData.forEach(row => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${row['date']}</td>
                                <td>${row['지역명']}</td>
                                <td>${row['방문인구수']}</td>
                            `;
                            tableBody.appendChild(tr);
                        });
                    {% endif %}
                }
            </script>
        {% endif %}

        {% if full_table_data %}
            <h2>필터링된 데이터</h2>
            <table border="1" id="data-table">
                <thead>
                    <tr>
                        <th>연-월</th>
                        <th>지역명</th>
                        <th>방문인구수</th>
                    </tr>
                </thead>
                <tbody id="data-table-body">
                    {% for row in full_table_data %}
                        <tr>
                            <td>{{ row.date }}</td>
                            <td>{{ row.지역명 }}</td>
                            <td>{{ row.방문인구수 }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            <h2>지역별 방문자 수 (누적)</h2>
            <canvas id="barChart" width="400" height="200"></canvas>
            <script>
                const barCtx = document.getElementById('barChart').getContext('2d');
                const regionLabels = fullTableData.map(row => row['지역명']);
                const visitData = fullTableData.map(row => row['방문인구수']);

                const barChart = new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: regionLabels,
                        datasets: [{
                            label: '지역별 방문자 수',
                            data: visitData,
                            backgroundColor: 'rgba(153, 102, 255, 0.2)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            </script>
        {% endif %}
    </div>
</body>
</html>
